{
  "hash": "19e93c6d3af003dc0ee99c4a23057e0c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"\\U0001F0CF Permutation Test for Two Proportions\"\nauthor: \"Arvind Venkatadri\"\ndate: 10/Nov/2022\nsubtitle: \"Test Proportions\"\nlastmod: \"2025-07-17\"\ncategories:\n- Permutation\n- Monte Carlo Simulation\n- Random Number Generation\n- Distributions\n- Generating Parallel Worlds\n---\n\n## Setting up the Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(mosaic)\nlibrary(ggmosaic) # plotting mosaic plots for Categorical Data\n\n### Dataset from Chihara and Hesterberg's book (Second Edition)\nlibrary(resampledata)\nlibrary(explore)\n```\n:::\n\n\n## Introduction\n\nWe saw from the diagram created by Allen Downey that *there is only one\ntest*! We will now use this philosophy to develop a technique that\nallows us to mechanize several *Statistical Models* in that way, with\nnearly identical code.\n\nWe will use two packages in R, `mosaic` and the relatively new `infer`\npackage, to develop our intuition for what are called **permutation**\nbased statistical tests.\n\n## Testing for Two or More Proportions\n\nLet us try a dataset with Qualitative / Categorical data. This is the\nGeneral Social Survey GSS dataset, and we have people with different\nlevels of `Education` stating their opinion on the `Death Penalty`. We\nwant to know if these two Categorical variables have a correlation, i.e.\ncan the opinions in favour of the `Death Penalty` be explained by the\n`Education` level?\n\nSince data is Categorical ( both variables ), we need to take `counts`\nin a table, and then implement a `chi-square test`. In the test, we will\npermute the `Education` variable to see if we can see how significant\nits *effect size* is.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(GSS2002)\ninspect(GSS2002)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\ncategorical variables:  \n            name  class levels    n missing\n1         Region factor      7 2765       0\n2         Gender factor      2 2765       0\n3           Race factor      3 2765       0\n4      Education factor      5 2760       5\n5        Marital factor      5 2765       0\n6       Religion factor     13 2746      19\n7          Happy factor      3 1369    1396\n8         Income factor     24 1875     890\n9       PolParty factor      8 2729      36\n10      Politics factor      7 1331    1434\n11     Marijuana factor      2  851    1914\n12  DeathPenalty factor      2 1308    1457\n13        OwnGun factor      3  924    1841\n14        GunLaw factor      2  916    1849\n15 SpendMilitary factor      3 1324    1441\n16     SpendEduc factor      3 1343    1422\n17      SpendEnv factor      3 1322    1443\n18      SpendSci factor      3 1266    1499\n19        Pres00 factor      5 1749    1016\n20      Postlife factor      2 1211    1554\n                                    distribution\n1  North Central (24.7%) ...                    \n2  Female (55.6%), Male (44.4%)                 \n3  White (79.1%), Black (14.8%) ...             \n4  HS (53.8%), Bachelors (16.1%) ...            \n5  Married (45.9%), Never Married (25.6%) ...   \n6  Protestant (53.2%), Catholic (24.5%) ...     \n7  Pretty happy (57.3%) ...                     \n8  40000-49999 (9.1%) ...                       \n9  Ind (19.3%), Not Str Dem (18.9%) ...         \n10 Moderate (39.2%), Conservative (15.8%) ...   \n11 Not legal (64%), Legal (36%)                 \n12 Favor (68.7%), Oppose (31.3%)                \n13 No (65.5%), Yes (33.5%) ...                  \n14 Favor (80.5%), Oppose (19.5%)                \n15 About right (46.5%) ...                      \n16 Too little (73.9%) ...                       \n17 Too little (60%) ...                         \n18 About right (49.7%) ...                      \n19 Bush (50.6%), Gore (44.7%) ...               \n20 Yes (80.5%), No (19.5%)                      \n\nquantitative variables:  \n  name   class min  Q1 median   Q3  max mean       sd    n missing\n1   ID integer   1 692   1383 2074 2765 1383 798.3311 2765       0\n```\n\n\n:::\n:::\n\n\nNote how *all* variables are Categorical !! `Education` has five\n`levels`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nGSS2002 %>% count(Education)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"Education\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"n\"],\"name\":[2],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Left HS\",\"2\":\"400\"},{\"1\":\"HS\",\"2\":\"1485\"},{\"1\":\"Jr Col\",\"2\":\"202\"},{\"1\":\"Bachelors\",\"2\":\"443\"},{\"1\":\"Graduate\",\"2\":\"230\"},{\"1\":\"NA\",\"2\":\"5\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\nGSS2002 %>% count(DeathPenalty)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"DeathPenalty\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"n\"],\"name\":[2],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Favor\",\"2\":\"899\"},{\"1\":\"Oppose\",\"2\":\"409\"},{\"1\":\"NA\",\"2\":\"1457\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nLet us drop NA entries in `Education` and `Death Penalty`. And set up a\ntable for the chi-square test.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngss2002 <- GSS2002 %>%\n  dplyr::select(Education, DeathPenalty) %>%\n  tidyr::drop_na(., c(Education, DeathPenalty))\ndim(gss2002)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1307    2\n```\n\n\n:::\n\n```{.r .cell-code}\ngss_summary <- gss2002 %>%\n  mutate(\n    Education = factor(\n      Education,\n      levels = c(\"Bachelors\", \"Graduate\", \"Jr Col\", \"HS\", \"Left HS\"),\n      labels = c(\"Bachelors\", \"Graduate\", \"Jr Col\", \"HS\", \"Left HS\")\n    ),\n    DeathPenalty = as.factor(DeathPenalty)\n  ) %>%\n  group_by(Education, DeathPenalty) %>%\n  summarise(count = n()) %>% # This is good for a chisq test\n\n  # Add two more columns to facilitate mosaic/Marrimekko Plot\n  #\n  mutate(\n    edu_count = sum(count),\n    edu_prop = count / sum(count)\n  ) %>%\n  ungroup()\n\ngss_summary\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"Education\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"DeathPenalty\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"count\"],\"name\":[3],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"edu_count\"],\"name\":[4],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"edu_prop\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Bachelors\",\"2\":\"Favor\",\"3\":\"135\",\"4\":\"206\",\"5\":\"0.6553398\"},{\"1\":\"Bachelors\",\"2\":\"Oppose\",\"3\":\"71\",\"4\":\"206\",\"5\":\"0.3446602\"},{\"1\":\"Graduate\",\"2\":\"Favor\",\"3\":\"64\",\"4\":\"114\",\"5\":\"0.5614035\"},{\"1\":\"Graduate\",\"2\":\"Oppose\",\"3\":\"50\",\"4\":\"114\",\"5\":\"0.4385965\"},{\"1\":\"Jr Col\",\"2\":\"Favor\",\"3\":\"71\",\"4\":\"87\",\"5\":\"0.8160920\"},{\"1\":\"Jr Col\",\"2\":\"Oppose\",\"3\":\"16\",\"4\":\"87\",\"5\":\"0.1839080\"},{\"1\":\"HS\",\"2\":\"Favor\",\"3\":\"511\",\"4\":\"711\",\"5\":\"0.7187060\"},{\"1\":\"HS\",\"2\":\"Oppose\",\"3\":\"200\",\"4\":\"711\",\"5\":\"0.2812940\"},{\"1\":\"Left HS\",\"2\":\"Favor\",\"3\":\"117\",\"4\":\"189\",\"5\":\"0.6190476\"},{\"1\":\"Left HS\",\"2\":\"Oppose\",\"3\":\"72\",\"4\":\"189\",\"5\":\"0.3809524\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n## Table Plots {#sec-table-plots .tabset .tabset-pills}\n\nWe can plot a heatmap-like `mosaic chart` for this table.\n\n### Using `ggplot` {.active}\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# https://stackoverflow.com/questions/19233365/how-to-create-a-marimekko-mosaic-plot-in-ggplot2\n\nggplot(data = gss_summary, aes(x = Education, y = edu_prop)) +\n  geom_bar(aes(width = edu_count, fill = DeathPenalty),\n    stat = \"identity\",\n    position = \"fill\",\n    colour = \"black\"\n  ) +\n  geom_text(aes(label = scales::percent(edu_prop)),\n    position = position_stack(vjust = 0.5)\n  ) +\n\n\n  # if labels are desired\n  facet_grid(~Education, scales = \"free_x\", space = \"free_x\") +\n  theme(scale_fill_brewer(palette = \"RdYlGn\")) +\n  # theme(panel.spacing.x = unit(0, \"npc\")) + # if no spacing preferred between bars\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](one-mean-tutorial_files/figure-html/unnamed-chunk-4-1.png){width=2100}\n:::\n:::\n\n\n### Using `ggmosaic`\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# library(ggmosaic)\n\nggplot(data = gss2002) +\n  geom_mosaic(aes(x = product(DeathPenalty, Education), fill = DeathPenalty))\n```\n\n::: {.cell-output-display}\n![](one-mean-tutorial_files/figure-html/mosaic-plot-1.png){width=2100}\n:::\n:::\n\n\n##  {.unnumbered}\n\n### Observed Statistic: the X\\^2 metric\n\nWhen there are multiple proportions involved, the X\\^2 test is what is\nused.\n\nLet us now perform the base `chisq test`: We need a `table` and then the\n`chisq` test:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngss_table <- tally(DeathPenalty ~ Education, data = gss2002)\ngss_table\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n            Education\nDeathPenalty Left HS  HS Jr Col Bachelors Graduate\n      Favor      117 511     71       135       64\n      Oppose      72 200     16        71       50\n```\n\n\n:::\n\n```{.r .cell-code}\n# Get the observed chi-square statistic\nobservedChi2 <- mosaic::chisq(tally(DeathPenalty ~ Education, data = gss2002))\nobservedChi2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nX.squared \n 23.45093 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Actual chi-square test\nstats::chisq.test(tally(DeathPenalty ~ Education, data = gss2002))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tPearson's Chi-squared test\n\ndata:  tally(DeathPenalty ~ Education, data = gss2002)\nX-squared = 23.451, df = 4, p-value = 0.0001029\n```\n\n\n:::\n:::\n\n\nWhat would our Hypotheses be?\n\n\\$\\$ H_0: Education Does Not affect Votes on Death Penalty\\\\\\\nH_a: Education affects Votes on Death Penalty\\\n\n\\$\\$\n\nWe should now repeat the test with permutations on `Education`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnull_chisq <- do(10000) * chisq.test(tally(DeathPenalty ~ shuffle(Education), data = gss2002))\n\nhead(null_chisq)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"X.squared\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"df\"],\"name\":[2],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"p.value\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"method\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"alternative\"],\"name\":[5],\"type\":[\"lgl\"],\"align\":[\"right\"]},{\"label\":[\"data\"],\"name\":[6],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\".row\"],\"name\":[7],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\".index\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"10.6515652\",\"2\":\"4\",\"3\":\"0.03077204\",\"4\":\"Pearson's Chi-squared test\",\"5\":\"NA\",\"6\":\"tally(DeathPenalty ~ shuffle(Education), data = gss2002)\",\"7\":\"1\",\"8\":\"1\",\"_rn_\":\"X-squared...1\"},{\"1\":\"2.1176276\",\"2\":\"4\",\"3\":\"0.71413461\",\"4\":\"Pearson's Chi-squared test\",\"5\":\"NA\",\"6\":\"tally(DeathPenalty ~ shuffle(Education), data = gss2002)\",\"7\":\"1\",\"8\":\"2\",\"_rn_\":\"X-squared...2\"},{\"1\":\"3.7358416\",\"2\":\"4\",\"3\":\"0.44293445\",\"4\":\"Pearson's Chi-squared test\",\"5\":\"NA\",\"6\":\"tally(DeathPenalty ~ shuffle(Education), data = gss2002)\",\"7\":\"1\",\"8\":\"3\",\"_rn_\":\"X-squared...3\"},{\"1\":\"5.7810264\",\"2\":\"4\",\"3\":\"0.21610905\",\"4\":\"Pearson's Chi-squared test\",\"5\":\"NA\",\"6\":\"tally(DeathPenalty ~ shuffle(Education), data = gss2002)\",\"7\":\"1\",\"8\":\"4\",\"_rn_\":\"X-squared...4\"},{\"1\":\"3.5578231\",\"2\":\"4\",\"3\":\"0.46914085\",\"4\":\"Pearson's Chi-squared test\",\"5\":\"NA\",\"6\":\"tally(DeathPenalty ~ shuffle(Education), data = gss2002)\",\"7\":\"1\",\"8\":\"5\",\"_rn_\":\"X-squared...5\"},{\"1\":\"0.8104932\",\"2\":\"4\",\"3\":\"0.93703580\",\"4\":\"Pearson's Chi-squared test\",\"5\":\"NA\",\"6\":\"tally(DeathPenalty ~ shuffle(Education), data = gss2002)\",\"7\":\"1\",\"8\":\"6\",\"_rn_\":\"X-squared...6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\ngf_histogram(~X.squared, data = null_chisq) %>%\n  gf_vline(xintercept = observedChi2, color = \"red\")\n```\n\n::: {.cell-output-display}\n![](one-mean-tutorial_files/figure-html/unnamed-chunk-6-1.png){width=2100}\n:::\n\n```{.r .cell-code}\nprop1(~ X.squared >= observedChi2, data = null_chisq)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nprop_TRUE \n9.999e-05 \n```\n\n\n:::\n:::\n\n\nThe `p-value` is well below our threshold of $0.05%$, so we would\nconclude that `Education` has a significant effect on `DeathPenalty`\nopinion!\n\n## Conclusion\n\nSo, what do you think?\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../../../../../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../../../../../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}